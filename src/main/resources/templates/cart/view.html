<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - Book Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
    <!-- Navigation -->
    <nav th:replace="~{layout/header :: header}"></nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <h1 class="mb-4">ðŸ›’ Shopping Cart</h1>

        <!-- Success/Error Messages -->
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Cart Items -->
        <div th:if="${cart != null and cart.cartItems != null and !cart.cartItems.empty}">
            <!-- CSRF Token for JavaScript -->
            <input type="hidden" id="csrfToken" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" 
                                           class="form-check-input me-2" 
                                           id="selectAll"
                                           style="width: 20px; height: 20px; cursor: pointer;"
                                           onchange="selectAll()">
                                    <h5 class="card-title mb-0">Cart Items</h5>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSelected()" id="removeSelectedBtn" disabled>
                                        <i class="bi bi-trash me-1"></i>Remove Selected
                                    </button>
                                </div>
                            </div>
                            
                            <div th:each="item : ${cart.cartItems}">
                                <div class="d-flex mb-4 pb-4 border-bottom" th:unless="${item == cart.cartItems.last}">
                                    <div class="flex-shrink-0 me-3">
                                        <input type="checkbox" 
                                               class="form-check-input cart-item-checkbox" 
                                               th:id="'checkbox-' + ${item.cartItemId}"
                                               th:value="${item.cartItemId}"
                                               th:attr="data-price=${item.bookPrice}, data-quantity=${item.quantity}, data-subtotal=${item.subtotal}"
                                               style="width: 20px; height: 20px; cursor: pointer;"
                                               onchange="updateTotals()">
                                    </div>
                                    <div class="flex-shrink-0">
                                        <a th:href= "@{/books/{id}(id=${item.bookId})}">
                                            <img th:src="${item.bookImageUrl}" 
                                                 class="img-thumbnail" 
                                                 style="width: 100px; height: 120px; object-fit: cover;"
                                                 th:alt="${item.bookTitle}">
                                        </a>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <a th:href= "@{/books/{id}(id=${item.bookId})}" class="text-decoration-none">
                                            <h6 th:text="${item.bookTitle}">Book Title</h6>
                                        </a>
                                        <p class="text-muted mb-2" th:text="${item.bookAuthor}">Author</p>
                                        <p class="text-primary mb-2" th:text="${T(com.second_project.book_store.util.CurrencyUtils).formatVND(item.bookPrice)}">0 VND</p>
                                        
                                        <!-- Quantity Selector -->
                                        <div class="input-group" style="width: 150px;">
                                            <button class="btn btn-outline-secondary cart-decrement-btn" type="button" 
                                                    th:attr="data-item-id=${item.cartItemId}"
                                                    th:disabled="${item.quantity <= 1}">
                                                <i class="bi bi-dash"></i>
                                            </button>
                                            <input type="text" 
                                                   class="form-control text-center" 
                                                   th:id="'quantity-' + ${item.cartItemId}"
                                                   th:value="${item.quantity}" 
                                                   readonly
                                                   th:attr="data-max=${item.availableStock}, data-item-id=${item.cartItemId}">
                                            <button class="btn btn-outline-secondary cart-increment-btn" type="button" 
                                                    th:attr="data-item-id=${item.cartItemId}"
                                                    th:disabled="${item.quantity >= item.availableStock}">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>

                                        <small class="text-muted d-block mt-2">
                                            Stock: <span th:text="${item.availableStock}">0</span> available
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <p class="h6 mb-2" th:id="'subtotal-' + ${item.cartItemId}" th:text="${#numbers.formatInteger(item.subtotal.longValue(), 1, 'COMMA')} + ' VND'">0 VND</p>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                th:onclick="'removeCartItem(' + ${item.cartItemId} + ')'">
                                            <i class="bi bi-trash"></i> Remove
                                        </button>
                                    </div>
                                </div>
                                <!-- Last item without border -->
                                <div class="d-flex mb-4" th:if="${item == cart.cartItems.last}">
                                    <div class="flex-shrink-0 me-3">
                                        <input type="checkbox" 
                                               class="form-check-input cart-item-checkbox" 
                                               th:id="'checkbox-' + ${item.cartItemId}"
                                               th:value="${item.cartItemId}"
                                               th:attr="data-price=${item.bookPrice}, data-quantity=${item.quantity}, data-subtotal=${item.subtotal}"
                                               style="width: 20px; height: 20px; cursor: pointer;"
                                               onchange="updateTotals()">
                                    </div>
                                    <div class="flex-shrink-0">
                                        <a th:href= "@{/books/{id}(id=${item.bookId})}">
                                            <img th:src="${item.bookImageUrl}" 
                                                 class="img-thumbnail" 
                                                 style="width: 100px; height: 120px; object-fit: cover;"
                                                 th:alt="${item.bookTitle}">
                                        </a>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <a th:href= "@{/books/{id}(id=${item.bookId})}" class="text-decoration-none">
                                            <h6 th:text="${item.bookTitle}">Book Title</h6>
                                        </a>
                                        <p class="text-muted mb-2" th:text="${item.bookAuthor}">Author</p>
                                        <p class="text-primary mb-2" th:text="${T(com.second_project.book_store.util.CurrencyUtils).formatVND(item.bookPrice)}">0 VND</p>
                                        
                                        <!-- Quantity Selector -->
                                        <div class="input-group" style="width: 150px;">
                                            <button class="btn btn-outline-secondary cart-decrement-btn" type="button" 
                                                    th:attr="data-item-id=${item.cartItemId}"
                                                    th:disabled="${item.quantity <= 1}">
                                                <i class="bi bi-dash"></i>
                                            </button>
                                            <input type="text" 
                                                   class="form-control text-center" 
                                                   th:id="'quantity-' + ${item.cartItemId}"
                                                   th:value="${item.quantity}" 
                                                   readonly
                                                   th:attr="data-max=${item.availableStock}, data-item-id=${item.cartItemId}">
                                            <button class="btn btn-outline-secondary cart-increment-btn" type="button" 
                                                    th:attr="data-item-id=${item.cartItemId}"
                                                    th:disabled="${item.quantity >= item.availableStock}">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>

                                        <small class="text-muted d-block mt-2">
                                            Stock: <span th:text="${item.availableStock}">0</span> available
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <p class="h6 mb-2" th:id="'subtotal-' + ${item.cartItemId}" th:text="${#numbers.formatInteger(item.subtotal.longValue(), 1, 'COMMA')} + ' VND'">0 VND</p>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                th:onclick="'removeCartItem(' + ${item.cartItemId} + ')'">
                                            <i class="bi bi-trash"></i> Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-4">Order Summary</h5>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Items (<span id="selectedItemsCount">0</span>):</span>
                                <span id="selectedItemsTotal">0 VND</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Total:</strong>
                                <strong class="h5 text-primary" id="selectedTotal">0 VND</strong>
                            </div>
                            <button type="button" class="btn btn-primary btn-lg w-100" onclick="proceedToCheckout()" id="checkoutBtn" disabled>
                                <i class="bi bi-credit-card me-2"></i>Proceed to Checkout
                            </button>
                            <a th:href="@{/books}" class="btn btn-outline-secondary w-100 mt-2">
                                <i class="bi bi-arrow-left me-2"></i>Continue Shopping
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty Cart -->
        <div th:if="${cart == null or cart.cartItems == null or cart.cartItems.empty}" class="text-center py-5">
            <i class="bi bi-cart-x" style="font-size: 4rem; color: #ccc;"></i>
            <h3 class="mt-3">Your cart is empty</h3>
            <p class="text-muted">Start shopping to add items to your cart</p>
            <a th:href="@{/books}" class="btn btn-primary mt-3">
                <i class="bi bi-book me-2"></i>Browse Books
            </a>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Cart Management Script -->
    <script>
        let cartAutoChangeInterval = null;
        let cartAutoChangeTimeout = null;
        let cartAutoChangeCartItemId = null;
        let cartAutoChangeDelta = 0;
        
        // Start auto increment/decrement for cart items
        function startCartAutoChange(cartItemId, delta) {
            stopCartAutoChange();
            
            cartAutoChangeCartItemId = cartItemId;
            cartAutoChangeDelta = delta;
            
            // Immediate first change
            changeCartQuantity(cartItemId, delta);
            
            // Set up interval for continuous change after 500ms delay
            cartAutoChangeTimeout = setTimeout(() => {
                cartAutoChangeInterval = setInterval(() => {
                    changeCartQuantity(cartAutoChangeCartItemId, cartAutoChangeDelta);
                }, 100);
            }, 500);
        }
        
        // Stop auto increment/decrement for cart items
        function stopCartAutoChange() {
            if (cartAutoChangeTimeout) {
                clearTimeout(cartAutoChangeTimeout);
                cartAutoChangeTimeout = null;
            }
            if (cartAutoChangeInterval) {
                clearInterval(cartAutoChangeInterval);
                cartAutoChangeInterval = null;
            }
            cartAutoChangeCartItemId = null;
            cartAutoChangeDelta = 0;
        }
        
        // Update button states for cart quantity
        function updateCartQuantityButtons(cartItemId) {
            const quantityInput = document.getElementById('quantity-' + cartItemId);
            if (!quantityInput) return;
            
            const maxQuantity = parseInt(quantityInput.getAttribute('data-max')) || 999999;
            const currentQuantity = parseInt(quantityInput.value) || 1;
            
            const decrementBtns = document.querySelectorAll('.cart-decrement-btn[data-item-id="' + cartItemId + '"]');
            const incrementBtns = document.querySelectorAll('.cart-increment-btn[data-item-id="' + cartItemId + '"]');
            
            decrementBtns.forEach(btn => {
                btn.disabled = (currentQuantity <= 1);
            });
            incrementBtns.forEach(btn => {
                btn.disabled = (currentQuantity >= maxQuantity);
            });
        }
        
        // Update quantity for a cart item
        function changeCartQuantity(cartItemId, delta) {
            const quantityInput = document.getElementById('quantity-' + cartItemId);
            if (!quantityInput) return;
            
            const maxQuantity = parseInt(quantityInput.getAttribute('data-max')) || 999999;
            let currentQuantity = parseInt(quantityInput.value) || 1;
            
            currentQuantity += delta;
            
            if (currentQuantity < 1) {
                currentQuantity = 1;
            } else if (currentQuantity > maxQuantity) {
                currentQuantity = maxQuantity;
            }
            
            // Update input value
            quantityInput.value = currentQuantity;
            
            // Update button states
            updateCartQuantityButtons(cartItemId);
            
            // Update quantity via form submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/cart/update/' + cartItemId;
            
            const csrfToken = document.getElementById('csrfToken').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_csrf';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            const quantityInputField = document.createElement('input');
            quantityInputField.type = 'hidden';
            quantityInputField.name = 'quantity';
            quantityInputField.value = currentQuantity;
            form.appendChild(quantityInputField);
            
            document.body.appendChild(form);
            form.submit();
        }
        
        // Remove a single cart item
        function removeCartItem(cartItemId) {
            if (confirm('Are you sure you want to remove this item from your cart?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/cart/remove/' + cartItemId;
                
                const csrfToken = document.getElementById('csrfToken').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // Update totals and button states based on selected items
        function updateTotals() {
            const checkboxes = document.querySelectorAll('.cart-item-checkbox');
            const checkedBoxes = document.querySelectorAll('.cart-item-checkbox:checked');
            const removeBtn = document.getElementById('removeSelectedBtn');
            const checkoutBtn = document.getElementById('checkoutBtn');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            // Update select all checkbox state
            if (selectAllCheckbox && checkboxes.length > 0) {
                selectAllCheckbox.checked = checkedBoxes.length === checkboxes.length;
            }
            
            // Update remove button state
            if (removeBtn) {
                removeBtn.disabled = checkedBoxes.length === 0;
            }
            
            // Calculate totals for selected items
            let totalItems = 0;
            let totalAmount = 0;
            
            checkedBoxes.forEach(checkbox => {
                const quantity = parseInt(checkbox.getAttribute('data-quantity')) || 0;
                const subtotal = parseFloat(checkbox.getAttribute('data-subtotal')) || 0;
                totalItems += quantity;
                totalAmount += subtotal;
            });
            
            // Update display
            const itemsCountEl = document.getElementById('selectedItemsCount');
            const itemsTotalEl = document.getElementById('selectedItemsTotal');
            const totalEl = document.getElementById('selectedTotal');
            
            if (itemsCountEl) {
                itemsCountEl.textContent = totalItems;
            }
            if (itemsTotalEl) {
                itemsTotalEl.textContent = formatVND(totalAmount);
            }
            if (totalEl) {
                totalEl.textContent = formatVND(totalAmount);
            }
            
            // Update checkout button state
            if (checkoutBtn) {
                checkoutBtn.disabled = checkedBoxes.length === 0;
            }
        }
        
        // Format number as VND (no decimals)
        function formatVND(amount) {
            // Round to whole number (VND doesn't use decimals)
            return Math.round(amount).toLocaleString('en-US') + ' VND';
        }
        
        // Update remove selected button state (kept for compatibility)
        function updateRemoveButton() {
            updateTotals();
        }
        
        // Remove selected items
        function removeSelected() {
            const checkboxes = document.querySelectorAll('.cart-item-checkbox:checked');
            if (checkboxes.length === 0) {
                return;
            }
            
            if (confirm('Are you sure you want to remove ' + checkboxes.length + ' selected item(s) from your cart?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/cart/remove-selected';
                
                const csrfToken = document.getElementById('csrfToken').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                checkboxes.forEach(checkbox => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'cartItemIds';
                    input.value = checkbox.value;
                    form.appendChild(input);
                });
                
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // Select all checkboxes
        function selectAll() {
            const checkboxes = document.querySelectorAll('.cart-item-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateTotals();
        }
        
        // Proceed to checkout with selected items
        function proceedToCheckout() {
            const checkboxes = document.querySelectorAll('.cart-item-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one item to checkout');
                return;
            }
            
            // Get selected item IDs and pass as query parameter
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            const selectedIdsParam = selectedIds.join(',');
            window.location.href = '/orders/checkout?selectedItems=' + encodeURIComponent(selectedIdsParam);
        }
        
        // Initialize totals on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check all items by default
            const checkboxes = document.querySelectorAll('.cart-item-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = true;
            }
            updateTotals();
            
            // Setup event listeners for quantity buttons
            const decrementBtns = document.querySelectorAll('.cart-decrement-btn');
            const incrementBtns = document.querySelectorAll('.cart-increment-btn');
            
            decrementBtns.forEach(btn => {
                const itemId = btn.getAttribute('data-item-id');
                
                // Mouse events
                btn.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    startCartAutoChange(itemId, -1);
                });
                btn.addEventListener('mouseup', stopCartAutoChange);
                btn.addEventListener('mouseleave', stopCartAutoChange);
                
                // Touch events for mobile
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    startCartAutoChange(itemId, -1);
                });
                btn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    stopCartAutoChange();
                });
            });
            
            incrementBtns.forEach(btn => {
                const itemId = btn.getAttribute('data-item-id');
                
                // Mouse events
                btn.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    startCartAutoChange(itemId, 1);
                });
                btn.addEventListener('mouseup', stopCartAutoChange);
                btn.addEventListener('mouseleave', stopCartAutoChange);
                
                // Touch events for mobile
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    startCartAutoChange(itemId, 1);
                });
                btn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    stopCartAutoChange();
                });
            });
        });
    </script>
    
    <!-- Footer -->
    <footer th:replace="~{layout/footer :: footer}"></footer>
</body>
</html>

